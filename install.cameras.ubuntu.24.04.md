# Instructions for installing Ubuntu 24.04 on cameras (the Zoneminder NVR system)

## Base install and configs

NOTE: This did not set up the 2 drives the same way, so the data is redundant, but we can't boot off the second drive. Needs a rebuild, likely when I move to new hardware which can process more streams more efficiently.

1. Install Ubuntu server as normal from an Ubuntu server install CD. I selected
   the default option because the minimal option was... too minimal.

   Partition as follows, for both disks - which we're going to RAID. In order to establish the partitions, I had to drop to a new VTY because the interface sucks balls. Once you have partitions, you return to the nice menu system to establish your RAID groups.

   * `/efi` - 1G - EFI System (type 1)
   * `/boot` - 1G - Linux RAID (type 43)
   * rest - Linux RAID (type 43)

   Then copy the partition scheme from one to the other, regenerating the GUID so there aren't any duplicates.

       sudo -s
       sfdisk -d /dev/sda | sfdisk /dev/sdb
       sfdisk --disk-id /dev/sdb `uuidgen`
       exit

   Then flip back to the installer, set `boot` to MD RAID, and set the rest to MD RAID with an LVM Group inside of it, with the following volumes:

       /     - 50GB
       /tmp  - 25GB
       /home - 10GB
       swap  - 10GB
       /var  - 10GB
       /var/cache/zoneminder - rest

   The default location for zoneminder stuff is `/var/cache/zoneminder/`, hence the big allocation there. But, it's also a separate volume so, if we fill it, we don't make the system unusable.

   **NOTE**: If when the installer says "you need to choose a boot device", they mean the **drive** not the partition. As long as you have an ESP (EFI System Partition) on the drive, you can then go to the drive and choose "Use As Boot Device". ~~Then go to the second drive and select "Add As Another Boot Device". This will set them up as primary and backup EFI System Partitions and life will be good.~~ It would, if the installer didn't fall on its face if you did this. So, **don't** select the second drive as another boot device. Just install on the primary, and we'll do the secondary device later.

   When it asks for what to install, install "OpenSSH server" and leave everything else blank.

   Networking is already set up with a reserved DHCP lease on the router. It is
   accessible as `cameras`. No need for a static IP.

1. After machine is up, edit `/etc/apt/sources.list.d/ubuntu.sources` and make sure the following are enabled:

       Suites: noble noble-updates noble-backports
       Components: main restricted universe multiverse

       Suites: noble-security
       Components: main restricted universe multiverse

    (they were properly set up after install for me)

1. Make sure all is up to date.

        sudo apt update
        sudo apt dist-upgrade

1. Install more useful things

       sudo apt install net-tools tree atop nmap iotop emacs emacs-goodies-el elpa-go-mode elpa-rust-mode elpa-f elpa-let-alist elpa-markdown-mode elpa-yaml-mode elpa-flycheck cpufrequtils symlinks sysstat ifstat dstat whois powertop latencytop apt-show-versions apt-file lm-sensors ntp ssmtp gdisk git iftop atop tree locate net-tools wget mailutils ppa-purge xsltproc smartmontools

1. Add any necessary user accounts

1. Set the timezone, if necessary:

       sudo timedatectl set-timezone America/New_York

1. Make ssh work:

    1. For an old machine, use the old keys - you did save /etc, didn't you?

    1. For a new machine, use the new keys generated by the distro.

        * make sure to add to the firewall

              sudo ufw allow ssh

        * edit `/etc/ssh/sshd_config` and set:

              PermitRootLogin no

        * once you've set up public key auth, turn off password access - edit `
          /etc/ssh/sshd_config` and set

              PasswordAuthentication no

        * restart ssh to apply changes

              sudo service ssh restart

1. Enable firewall, bit first, disable firewall logging (it can be quite
   verbose on a busy network), then turn on the firewall.

        sudo ufw logging off
        sudo ufw enable

1. Install grub on to the second hard disk.

   Remember, we tried to do this at install and it failed.

        grub-install /dev/sdb

1. Clone our standard set of scripts to the usual places

        mkdir -p ~/workspace/code/scripts
        cd ~/workspace/code/scripts
        git clone --depth=1 https://github.com/mattcaron/general_scripts.git general

   Then symlink them into place:

         mkdir ~/bin
         cd ~/bin
         ln -s ~/workspace/code/scripts/general/* .

1. Also make sure to copy over the `system_stuff` directory.

1. Add the `efi_sync` to the daily cron list:

         cd /etc/cron.daily
         sudo ln -s /home/matt/bin/efi_sync .

1. Set up ssmtp

        sudo -s
        cd /etc/ssmtp
        mv ssmtp.conf ssmtp.conf.old
        cp /home/matt/system_stuff/ssmtp/ssmtp.conf .
        chgrp mail ssmtp.conf
        chmod g+r ssmtp.conf
        exit

1. Add monitoring (sortof):

    make sure landscape is installed (to get landscape-sysinfo):

       sudo apt install landscape-common

    Then add the following to my crontab:

       @daily               /usr/bin/ntpq -p; echo; df -lh; echo; cat /proc/mdstat; landscape-sysinfo

## Zoneminder basic set up

1. Refs:
    * <https://zoneminder.readthedocs.io/en/latest/installationguide/ubuntu.html>

1. Add the deps, PPA and do the basic install:

       sudo apt install software-properties-common
       sudo add-apt-repository ppa:iconnor/zoneminder-1.36
       sudo apt install zoneminder

1. Fix some perms and ownership:

       sudo chown root:www-data /etc/zm/zm.conf
       sudo chown -R www-data:www-data /usr/share/zoneminder/

1. Enable apache modules Zoneminder config:

       sudo a2enmod rewrite headers cgi php8.3 ssl
       sudo a2enconf zoneminder
       sudo systemctl restart apache2

1. Let it through the firewall

       sudo ufw allow http
       sudo ufw allow https

1. Set the timezone properly for PHP

   1. Edit `/etc/php/8.3/apache2/php.ini`
   1. Find the line `;date.timezone =`
   1. Uncomment it and set it to `date.timezone = America/New_York`

1. Enable and start zoneminder:

       sudo systemctl enable zoneminder
       sudo systemctl start zoneminder

1. Going to <http://cameras/zm> should now work. If not, you screwed up someplace.

1. Configure the site properly (http -> https redirect, SSH, etc.)

   1. In `/etc/apache2/sites-available`, create `zoneminder.conf` as follows:

          <VirtualHost *:80>
              ServerName cameras
              ServerAdmin matt@mattcaron.net

              RewriteEngine on    
              RewriteRule ^/(.*)$  https://cameras/zm/$1  [R,L]
          </VirtualHost>

          <VirtualHost *:443>

              ServerName cameras
              ServerAdmin matt@mattcaron.net

              SSLEngine on
              SSLCertificateFile    /etc/ssl/private/crt
              SSLCertificateKeyFile /etc/ssl/private/key

              <IfModule mod_headers.c>
                  Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains"
              </IfModule>

              RewriteEngine on
              RewriteRule ^/$  https://cameras/zm/  [R,L]
          </VirtualHost>

          # Generated from https://ssl-config.mozilla.org/

          # modern configuration
          SSLProtocol             all -SSLv3 -TLSv1 -TLSv1.1 -TLSv1.2
          SSLHonorCipherOrder     off
          SSLSessionTickets       off

          SSLUseStapling On
          SSLStaplingCache "shmcb:logs/ssl_stapling(32768)"

   1. Then disable the default and enable the above:

          sudo a2dissite 000-default
          sudo a2ensite zm-redirect
          sudo systemctl reload apache2

## Configure the server

### Configure Options

This is all under **Options**

All changes noted are from the defaults.

1. **System**:
    1. **LANG_DEFAULT** = `en_us`
    1. ~~**DATE_FORMAT_PATTERN** = `yyyyMMdd`~~
       * Don't set this for 1.36.xx. There's a bug that crashes the server and it's just not that important.
    1. **AUTH_HASH_SECRET** = Set to something random
    1. **OPT_USE_LEGACY_API_AUTH** = unchecked
      * Because it's a new installation
    1. **OPT_CONTROL** = unchecked
      * Because we don't have any PTZ cameras.
    1. TODO - **OPT_TRIGGERS** will be handy for SMTP uploads + triggers
    1. **CHECK_FOR_UPDATES** = unchecked
      * Redundant with the package manager having updates.
1. **Email**
    1. **OPT_EMAIL** = checked
        1. We don't check OPT_MESSAGE because it's a short message for SMS. Regular email is fine.
    1. **MESSAGE_ADDRESS** = my email
    1. **NEW_MAIL_MODULES** = checked
    1. **FROM_EMAIL** = my email
    1. **URL** = server url
    1. **SSMTP_MAIL** = checked
    1. **SSMTP_PATH** = `/usr/sbin/ssmtp`
1. **Users**
    1. Add users.
1. **System**:
    1. **OPT_USE_AUTH** = checked

### Configure video retention and notifications

1. Set up policy to delete old videos
    1. In the top bar, click **Filters**:
    1. Fill out the new filter as follows:
        * Name: `DeleteOldVideos`
        * Select:
            * Start Date/Time
            * less than
            * -30 days
                * This is for 30 day retention. Your needs may be different.
        * Under **Actions**, tick `Delete all matches`
        * Under **Options**, tick `Run filter in background`
    1. Click `Save`
    1. Click `Execute`

    Note that, if you're paranoid, don't tick the boxes under **Actions** and **Options**, and instead use either **List Matches** or **View Matches** to make sure your query is correct before deleting things.

    Also note that the syntax is weird. Since it's less than -30 days, it's 30 days in the future. It would be great if there was an "Age" item in the drop down, but alas, there is not.

    1. Fill out another new filter as follows:
        * Name: `Notifications`
        * Select:
            * Alarm Frames
            * greater than
            * 0
        * and
            * End Date/Time
            * greater than or equal to
            * -1 minute
        * Under **Actions**, tick `Email details of all matches`
        * Under **Options**, tick `Run filter in background` and then set:
            * Email To: <my email>
            * Email Subject: `ZM: %ED% on %MN% at %ET%`
            * Email Body:

                  An event has been detected on monitor %MN% at %ET%.

                  ID: %EI%

                  Description: %ED%

                  Cause: %EC%

                  View the event here: %ZP%?view=event&eid=%EI%.

                  An image is attached to this email.

                  %EIM%
    1. Click `Save`

## Add Neolink

So Reolink wireless cameras work.

### Compiling Neolink

I did this on my desktop, not the server. Since both run the same OS and it's a
(mostly) statically compiled rust binary, I just plan to copy it over from dev
box to server. Then you don't need to install the rust toolchain stuff on the server.

1. Clone it from its repo and check out the latest release:

       git clone https://github.com/QuantumEntangledAndy/neolink.git
       cd neolink
       git checkout 0.4.0 

1. Make sure rust and cargo are updated:

       rustup update

1. Make sure dependencies are installed (this is non-exhaustive, these are just
   the ones I had to add)

       sudo apt install libgstreamer1.0-dev libgstreamer-plugins-bad1.0-dev libgstreamer-plugins-good1.0-dev libgstrtspserver-1.0-dev

1. Then one can build it successfully with:

       cargo build --release

### Install on server

1. Install dependencies:

       sudo apt install libgstrtspserver-1.0-0 libgstreamer1.0-0  libgstreamer-plugins-bad1.0-0 gstreamer1.0-plugins-good gstreamer1.0-plugins-bad

1. Copy the binary over to the server.

1. Copy over the `sample_config.toml` (I called it `neolink_config.toml`) and
   adjust as follows:

    1. Set `bind` to 127.0.0.1, because we don't need anyone other than this
       server to be able to get those streams.

    1. Because it's localhost access only, we're not going to bother with
       credentials or encryption, as there's little point when it's two daemons
       talking to each other across the same system bus.

    1. The cameras have limited user functionality, so their username is always
       `admin`. The password is saved in Keepass.

1. Create a config section for each camera (see [below](#reolink-argus-eco)).
1. Set it up to start on boot

   1. Create `/etc/systemd/system/neolink.service` as follows:

          [Unit]
          Description=Neolink camera service
          After=network.target

          [Service]
          Type=simple
          ExecStart=/home/matt/neolink/neolink rtsp -c /home/matt/neolink/neolink_config.toml
          KillMode=process
          Restart=always
          WorkingDirectory=/home/matt/neolink
          User=matt
          Group=matt

          [Install]
          WantedBy=multi-user.target

   1. Then enable and start it:

          sudo systemctl enable neolink
          sudo systemctl start neolink

### Installing on the server

## Set up cameras

### Reolink RLC-520A

#### Camera Config

1. Connect it to power and network, let it boot up, then go to the router to see
   what MAC is has. Give it a static IP assignment on the router and reboot it.
   It should be at the new IP.

1. Go to https://<cameraname> and login. Default username is admin with no
   password.

1. Configure the camera however. You like. Of note:

   1. <https://support.reolink.com/hc/en-us/articles/360005238413-The-Difference-Between-Clear-Fluent-and-Balanced>
      explains the difference between the different streams.

1. Other settings to change on the camera from defaults:

   1. **Camera**:
       1. **Display**:
           1. **Camera Name**: Hide
           1. **Date & Time**: Hide
           1. **Watermark**: Off
           1. **Anti-flicker**: 60Hz
       1. **Stream**
           1. Set the **Clear** resolution to `2304*1296`
              * Anything HD and better is good enough, and the more pixels, the
                more disk usage and CPU needed for processing.
              * Turning down the FPS is also a good way to save CPU time - 15
                and over are good enough.
       1. **Audio and Light**
           1. **Record Audio**: On
       1. **Info**
           1. Set the name
   1. **Surveillance**:
       1. **Record**:
           1. **Record**: Off
       1. **Email**:
           1. **Enable Email Alerts**: Off
       1. **FTP**:
           1. **Enable FTP**: Off
       1. **Push**:
           1. Disable Push
   1. **Network Settings** -> **Advanced** drop down:
       1. **Enable UID**: Off
           1. We use this for the battery cameras, but not this type.
       1. **Port Settings** click "Set Up"
           1. **RTMP**: On
           1. **RTSP**: Off
               * RTMP works better.
           1. **ONVIF**: Off
               * ONVIF autodiscovery didn't work, and I'm not going to mess
                  with it right now. Might turn it on later.
   1. **System**:
       1. **Maintenance**:
           1. **Auto Reboot**: Off
       1. **User Management**:
           1. Set the admin password.
           1. Add another normal user for zoneminder.
              * Note that the password for the zoneminder user is passed in a
               URL, so can't contain special characters.
           * I saved both of these in Keepass.

#### Zoneminder Config

1. Add the camera in Zoneminder as follows (only non-default values are noted):
    1. **General**:
        1. **Function**: Modect
        1. **Reference Image Blend**: 12.5% (Outdoor)
        1. **Alarm Reference Image Blend**: 12.5%
    1. **Source**:
        1. **Source Path**: rtmp://<hostname>:1935/bcs/channel0_main.bcs?channel=0&stream=0&user=<user>&password=<password>
        1. **Method**: UDP
        1. **Capture Resolution** 2304*1296 (Custom)
    1. **Storage**:
        1. **Video Writer**: Camera Passthrough
        1. Tick the box to store audio too
    1. **Timestamp**
        1. **Timestamp Label Format** = `%N - %Y%m%d %I:%M:%S %p`
        1. **Font Size** = `Extra Large`
    1. **Misc**:
        1. Default Method For Viewing Events: MJPEG
            * MP4 doesn't work as well on mobile.

Note: You can use the substream as a trigger for the main recording, thus saving processing. See:

<https://www.reddit.com/r/reolinkcam/comments/jnurzm/adding_reolink_cameras_to_zoneminder_nvr/>

That source would be rtmp://<hostname>:1935/bcs/channel0_sub.bcs?channel=0&stream=0&user=<user>&password=<password>

### Reolink Argus Eco

#### Notes

1. This is a battery powered camera.

1. The only way I could figure out to do initial setup is with the app - this
   gets it connected to the network.

1. It only works via the Neolink RTSP bridge software (see above).

1. References: <https://github.com/QuantumEntangledAndy/neolink.git>

#### Camera Config

1. Set up the camera using the app - follow the voice prompts, scan the barcode,
   etc.

1. Once it's connected to the router, you can set the static DHCP reservation
   and DNS - though we won't actually use it.

1. In the app, configure it as follows (these are changes from default)
    1. Under **Display**:
        1. **Camera Name**: Hide
        1. **Date**: Hide
        1. **Watermark**: Off
    1. **Camera Recording**: Off
        1. There is no SD card.
    1. **Email Alerts**: Off

1. In the neolink config, add a section like this:

       [[cameras]]
       name = "batterycamera1"
       username = "admin"
       password = "something super secret"
       uid = "ABCD01234567890EFG"
       stream = "mainStream"

  Name should match what is set in the camera (but is probably not strictly
  necessary), username is always admin, password is what we set it to, and uid
  can be gotten from **Device Info** (which shows up if you tap on the gear icon
  and then the camera's name). **stream** can be either `mainStream` (which is
  the HD stream) or `subStream` (which is the low res stream).

#### Zoneminder Config

1. Add the camera in Zoneminder as follows (only non-default values are noted):
    1. **General**:
        1. **Function**: Modect
        1. **Reference Image Blend**: 12.5% (Outdoor)
        1. **Alarm Reference Image Blend**: 12.5%
    1. **Source**:
        1. **Source Path**:
           rtsp://localhost:8554/camera-name
           replace camera-name with the camera name
        1. **Method**: UDP
        1. **Capture Resolution** 1920x1072
          * It's supposed to be sending 1920x1080 but doesn't. Perhaps because of the neolink?
    1. **Storage**:
        1. **Video Writer**: Camera Passthrough
        1. Tick the box to store audio too
    1. **Timestamp**
        1. **Timestamp Label Format** = `%N - %Y%m%d %I:%M:%S %p`
        1. **Font Size** = `Extra Large`
    1. **Misc**:
        1. Default Method For Viewing Events: MJPEG
            * MP4 doesn't work as well on mobile.
