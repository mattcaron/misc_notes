# Installing Ubuntu 24.04 on Linode - second machine, for Joy of Nerding

I picked Dallas for the location.

## Basic setup

- I picked 512MB swap and used the rest for the single server
- Don't forget to configure DNS
- DNS servers:
  - ns1.linode.com
  - ns2.linode.com
  - ns3.linode.com
  - ns4.linode.com
  - ns5.linode.com

- And make sure to add an SPF record - it's a text record. By default, it's just:

      v=spf1 mx ~all

  Which says "accept mail from any servers which have an a record, and
  if it's not, soft fail it."

- Also, add a DMARC record:

      v=DMARC1; p=reject;

- Which says "use DMARC version 1, reject emails that don't meet criteria"

- You can also add:

      rua=mailto:postmaster@joyofnerding.com

  Which says "email the postmaster with summaries".. but that results in a lot of annoying emails saying "hey, stuff got passed through", so I didn't.    

1. Updates!

        sudo apt update
        sudo apt dist-upgrade

1. Make accounts

        adduser matt
        usermod -a -G sudo,adm matt

1. Install users' `authorized_keys` files in to `~/.ssh`

1. Set up ssh

    1. For an old machine, use the old keys - you did save /etc, didn't you?

    1. For a new machine, use the new keys generated by the distro.

    1. make sure to add to the firewall

           ufw allow ssh

    1. In `/etc/ssh/sshd_config`, set:

           PermitRootLogin forced-commands-only

        (the forced commands only is so we can run backups)
        and set

           PasswordAuthentication no

    1. restart it

           service ssh restart

1. Enable firewall

       sudo ufw enable

1. Set the hostname:

   1. Edit `/etc/hostname` and set it to joyofnerding
   1. Edit `/etc/hosts` and set the 127.0.1.1 line to look like:

          127.0.1.1      joyofnerding

   This will prevent bounce messages from some mailservers, since they rely on the host name that the server claims to be (which is gotten from /etc/hostname) and then try to reverse that and make sure they're the same.

1. Install useful things

       sudo apt install tree emacs-nox git software-properties-common snapd iftop htop

1. Lock root account

       sudo usermod -L root

1. Add monitoring:

    1. Make sure landscape is installed (to get landscape-sysinfo):

           sudo apt install landscape-common

    1. Then add the following to my crontab:

           @daily               df -lh; echo; landscape-sysinfo

1. Configure the time zone:

       sudo dpkg-reconfigure tzdata

   and set it to America/New York

## Certificates - letsencrypt certbot

1. Make sure to allow the http ports through the firewall so the cert setup works.

       sudo ufw allow http
       sudo ufw allow https

1. Install certbot snap

       sudo snap install --classic certbot

1. Set it up semi-manually:

       sudo certbot --standalone certonly -d joyofnerding.com,www.joyofnerding.com
       sudo certbot --standalone certonly -d thejoyofnerding.com,www.thejoyofnerding.com
       sudo certbot --standalone certonly -d mail.joyofnerding.com
       sudo certbot --standalone certonly -d mail.thejoyofnerding.com

1. Make the directories in /etc group accessible by ssl-cert and make the gid sticky

       sudo chgrp -R ssl-cert /etc/letsencrypt
       sudo chmod -R g+rX /etc/letsencrypt
       sudo find /etc/letsencrypt -type d -execdir chmod g+s '{}' \;

1. Move everything in `/etc/ssl/private` to old, and then make new symlinks to the things in `/etc/letsencrypt/live`.

1. Add create `/etc/cron.d/letsencrypt` thusly:

       # /etc/cron.d/letsencrypt: crontab entries to check for new certs

       PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/snap/bin
       MAILTO=root

       37 02 * * *     root     service nginx stop; certbot renew; chmod -R g+r /etc/letsencrypt; service nginx start; service dovecot reload; service exim4 reload

       # EOF

    Note that:
      - we restart services
      - we fix up the permissions to be group readable, because new files will be created as 0600.

## Webserver - nginx

1. Install packages:

       sudo apt install nginx

1. Allow it through the firewall

       sudo ufw allow http
       sudo ufw allow https

1. Create `/etc/nginx/sites-available/joyofnerding.com` as follows:

       # joyofnerding.com is the default server.

       server {
           listen 80 default_server;
           listen [::]:80 default_server;

           server_name joyofnerding.com www.joyofnerding.com;

           # All http gets redirected to https
           rewrite ^/$ https://www.joyofnerding.com permanent;
           rewrite ^/(.*)$ https://www.joyofnerding.com/$1 permanent;
       }

       server {
           listen 443 ssl default_server;
           listen [::]:443 ssl default_server;

           server_name joyofnerding.com www.joyofnerding.com;

           ssl_certificate /etc/ssl/private/joyofnerding.com/fullchain.pem;
           ssl_certificate_key /etc/ssl/private/joyofnerding.com/privkey.pem;

           # Note: You should disable gzip for SSL traffic.
           # See: https://bugs.debian.org/773332
           gzip off;
    
           root /home/matt/public_html/www.joyofnerding.com;

           # Add index.php to the list if you are using PHP
           index index.html index.htm index.nginx-debian.html;

           location / {
               # First attempt to serve request as file, then
               # as directory, then fall back to displaying a 404.
               try_files $uri $uri/ =404;
           }

           # deny access to .htaccess files, if Apache's document root
           # concurs with nginx's one
           #
           location ~ /\.ht {
               deny all;
           }
       }

1. Create `/etc/nginx/sites-available/thejoyofnerding.com` as follows:

       # thejoyofnerding.com redirects to joyofnerding.com

       server {
           listen 80;
           listen [::]:80;

           server_name thejoyofnerding.com www.thejoyofnerding.com;

           # All thejoyofnerding.com gets redirected to joyofnerding.com
           rewrite ^/$ https://www.joyofnerding.com permanent;
           rewrite ^/(.*)$ https://www.joyofnerding.com/$1 permanent;
       }

       server {
           listen 443 ssl;
           listen [::]:443 ssl;

           server_name thejoyofnerding.com www.thejoyofnerding.com;

           ssl_certificate /etc/ssl/private/thejoyofnerding.com/fullchain.pem;
           ssl_certificate_key /etc/ssl/private/thejoyofnerding.com/privkey.pem;

           #  Note: You should disable gzip for SSL traffic.
           # See: https://bugs.debian.org/773332
           gzip off;

           # All thejoyofnerding.com gets redirected to joyofnerding.com
           rewrite ^/$ https://www.joyofnerding.com permanent;
           rewrite ^/(.*)$ https://www.joyofnerding.com/$1 permanent;
       }

1. Edit `/etc/nginx/nginx.conf`. Find the `SSL Settings` section, remove all the existing code, and add the following:

        # Generated from https://ssl-config.mozilla.org/

        ssl_session_timeout 1d;
        ssl_session_cache shared:MozSSL:10m;  # about 40000 sessions

        # modern configuration
        ssl_protocols TLSv1.3;
        ssl_prefer_server_ciphers off;

        # HSTS (ngx_http_headers_module is required) (63072000 seconds)
        add_header Strict-Transport-Security "max-age=63072000" always;

        # OCSP stapling
        ssl_stapling on;
        ssl_stapling_verify on;

1. Disable the default site, enable these, and restart the server.

       cd /etc/nginx/sites-enabled/
       sudo rm default
       sudo ln -s /etc/nginx/sites-available/joyofnerding.com
       sudo ln -s /etc/nginx/sites-available/thejoyofnerding.com

## Mail - dovecot / exim / spamassassin

1. Install dovecot (imap)
    - Based on: <https://help.ubuntu.com/community/Dovecot>

    1. Install it:

           sudo apt install dovecot-imapd

    1. Configure it:

       1. Edit `/etc/dovecot/conf.d/10-master.conf` and:
           1. find the `inet_listener imaps` line, and uncomment the body.
               - ref: <http://wiki2.dovecot.org/HowTo/EximAndDovecotSASL>
           1. find the `service auth` section and add to the bottom:
  
                  #SASL                                                                         
                  unix_listener auth-client {
                    mode = 0600
                    user = Debian-exim
                  }

           1. At the bottom, add the following:

                  service stats {
                    unix_listener stats-reader {
                      mode = 0666
                    }
                    unix_listener stats-writer {
                      mode = 0666
                    }
                  }

       1. Edit `/etc/dovecot/conf.d/10-mail.conf` and find the `mail_location` line, uncomment it and set it to:

              mail_location = maildir:/home/%u/Maildir

       1. Edit `/etc/dovecot/conf.d/10-ssl.conf` and:
          1. Change it to use the mattcaron.net cert:

                 ssl_cert = </etc/ssl/private/mail.joyofnerding.com/fullchain.pem
                 ssl_key = </etc/ssl/private/mail.joyofnerding.com/privkey.pem

          1. Change ssl to "required"

                 ssl = required

       1. Edit `/etc/dovecot/conf.d/20-imap.conf` and set:

                 mail_max_userip_connections = 100

          (because I have a ton of machines that poll for email behind a NAT)

       1. Edit `/etc/dovecot/conf.d/15-lda.conf` and set:
  
              postmaster_address = postmaster

           Yes, this is kind of stupid, especially in light of the comment in the config preceding this line, but I've been getting errors about how it's not set, to just explicitly set it to the sane default.

    1. Pre-create the maildir for new users

           sudo maildirmake.dovecot /etc/skel/Maildir
           sudo maildirmake.dovecot /etc/skel/Maildir/.Drafts
           sudo maildirmake.dovecot /etc/skel/Maildir/.Sent
           sudo maildirmake.dovecot /etc/skel/Maildir/.Trash
           sudo maildirmake.dovecot /etc/skel/Maildir/.Templates
           sudo maildirmake.dovecot /etc/skel/Maildir/.Junk

    1. Set it up for any existing users:

           sudo cp -r /etc/skel/Maildir /home/myuser/
           sudo chown -R myuser:usergroup /home/myuser/Maildir
           sudo chmod -R 700 /home/myuser/Maildir

    1. Allow it through the firewall

           sudo ufw allow imaps

    1. Enable and start it

           sudo update-rc.d dovecot enable
           sudo service dovecot start

1. Exim

    1. Install it

           sudo apt install exim4-daemon-heavy exim4

    1. Find the default exim configuration file (called `configure.default`, and found in the `src/` directory of the source code and modify it as follows:

           primary_hostname = joyofnerding.com
           domainlist local_domains = joyofnerding.com : thejoyofnerding.com
           domainlist relay_to_domains = hostlist
           relay_from_hosts = localhost
           tls_advertise_hosts = *
           tls_certificate = /etc/ssl/private/mail.joyofnerding.com/fullchain.pem
           tls_privatekey = /etc/ssl/private/mail.joyofnerding.com/privkey.pem
           daemon_smtp_ports = 25 : 465
           tls_on_connect_ports = 465
           qualify_domain = mattcaron.net
           auth_advertise_hosts = ${if eq {$tls_cipher}{}{}{*}}

       1. Find the `system_aliases` router and change the line:

              data = ${lookup{$local_part}lsearch{SYSTEM_ALIASES_FILE}}

          to:

              data = ${lookup{$local_part}lsearch{/etc/aliases}}

           Ref: <https://github.com/Exim/exim/wiki/AuthenticatedSmtpUsingPam>

       1. At the bottom of the main section (before ACL CONFIGURATION), add:

              # Only allow auth over TLS, otherwise folks would be sending plaintext passwords
              auth_advertise_hosts = ${if eq {$tls_cipher}{}{}{*}}

          Ref: <http://wiki2.dovecot.org/HowTo/EximAndDovecotSASL>

       1. Down at the bottom, at the end of the AUTHENTICATION CONFIGURATION, add:

              dovecot_plain:
                driver = dovecot
                public_name = PLAIN
                server_socket = /var/run/dovecot/auth-client
                server_set_id = $auth1

            Note that we don't use the default debian config, as it is annoying.

    1. Then copy the modified file to `/etc/exim4/exim4.conf` on the remote server. Make sure it's group readable and growned by `Debian-exim`.

    1. Make the `Debian-exim` user a member of the shadow group so it can read `/etc/shadow` and therefore do authentication. Also, the `ssl-cert` group, so it can read certs.

           sudo usermod -a -G ssl-cert Debian-exim
           sudo usermod -a -G shadow Debian-exim

    1. Make a pam config for it - we'll just piggyback on the dovecot one, as it's reasonable and similar

           cd /etc/pam.d
           sudo ln -s dovecot exim4

    1. Allow through firewall

           sudo ufw allow smtp
           sudo ufw allow ssmtp

    1. Enable and start it

           sudo update-rc.d exim4 enable
           sudo service exim4 start

1. Integrate exim with dovecot

   - Ref: <http://wiki2.dovecot.org/LDA/Exim>
  
    1. Edit `/etc/exim4/exim4.conf`

        1. At the bottom of the routers section, add the following (or change existing to look the same):

               localuser:
                 driver = accept
                 check_local_user
                 # local_part_suffix = +* : -*
                 # local_part_suffix_optional
                 transport = dovecot_delivery
                 cannot_route_message = Unknown user

        1. Create a new transport for dovecot-lda:

               dovecot_delivery:
                 driver = pipe
                   # You may or may not want to add -d $local_part@$domain depending on if
                   # you need a userdb lookup done.
                   command = /usr/lib/dovecot/dovecot-lda
                   message_prefix =
                   message_suffix =
                   log_output
                   delivery_date_add
                   envelope_to_add
                   return_path_add
                   #group = mail
                   #mode = 0660
                   temp_errors = 64 : 69 : 70: 71 : 72 : 73 : 74 : 75 : 78

1. Set up DKIM signing (because, you know, spammers won't sign messages or spoofing is a problem or, something..)
  
    - From: <https://www.debian-administration.org/article/718/DKIM-signing_outgoing_mail_with_exim4>

    1. Make some directories to hold things:

           sudo mkdir /etc/exim4/dkim
           cd /etc/exim4/dkim

    1. Generate keys for each domain:

           sudo openssl genrsa -out joyofnerding.com.private.pem 2048
           sudo openssl rsa -in joyofnerding.com.private.pem -out joyofnerding.com.pem -pubout

           sudo openssl genrsa -out thejoyofnerding.com.private.pem 2048
           sudo openssl rsa -in thejoyofnerding.com.private.pem -out thejoyofnerding.com.pem -pubout

    1. Publish the public keys in DNS using the date as the selector.
       1. IMPORTANT - my current exim config exim uses the same selector (date) for ALL domains, so they all need to match.

    1. Fix perms on generated files:

           sudo chown -R Debian-exim:Debian-exim /etc/exim4/dkim
           sudo chmod -R go-rwx /etc/exim4/dkim

    1. In `/etc/exim4/exim4.conf`:
       1. Cchange the `remote_smtp` section to be like this:

              remote_smtp:
                driver = smtp
                dkim_canon = relaxed
                dkim_selector = 20241022
                dkim_domain = ${sg{${lc:${domain:$h_from:}}}{^www\.}{}}
                dkim_private_key = ${if exists{/etc/exim4/dkim/${dkim_domain}.private.pem}{/etc/exim4/dkim/${dkim_domain}.private.pem}{0}}

       1. Allow remote MUA's to set the sender for the envelope. This stops exim from stripping it and forcing it to be the canonical domain (so we can support multiple virtual domains). Anyway, go to the end of the Main Configuration section, right above ACL CONFIGURATION and add:

              local_sender_retain = true
              local_from_check = false

1. Add spamassassin and other optional dependencies:

   1. install

          sudo apt install spamassassin libdigest-sha-perl libgeo-ip-perl libio-socket-ip-perl libencode-detect-perl libnet-patricia-perl libmodule-install-perl

      Note: this is helpful for debugging:

          spamassassin -D --lint 2>&1 | grep -i failed

   1. In `/etc/exim4/exim4.conf`:
       1. add the following router right before the "localuser" router:

              # router to send incoming email to spamcheck transport for checking 
              spamcheck_router:
                no_verify
                check_local_user
                # When to scan a message :
                #   -   it isn't already flagged as spam
                #   -   it isn't already scanned
                #   -   it isn't sent from my private home server
                #   -   it isn't sent from the server (linode or localhost)
                condition = "${if and { {!def:h_X-Spam-Flag:} {!eq {$received_protocol}{spam-scanned}} {!match {$sender_host_address} {${lookup dnsdb{a=mattandliz.dyndns.org}}}} {!match {$sender_host_address} {${lookup dnsdb{a=mattcaron.net}}}}} {1}{0}}"
                driver = accept
                transport = spamcheck

              # router to deliver spam to the junk folder
              spam_deliver_to_junk
                driver = accept
                check_local_user
                local_parts = !www:!root:!nobody:!postmaster:!abuse:!admin
                transport = dovecot_spam_junk_delivery
                condition = ${if def:h_X-Spam-Flag: {true}}

       1. add the following transport (it can go anywhere, order doesn't matter)

              # Scan for spam via spamassassin. Note that this works by calling exim
              # *again* and essentially redlivering the message, except that it has
              # already been scanned (see the "spam-scanned" add here, and the conditional
              # up in the router), so it only gets called the first time
              spamcheck:
                debug_print = "T: spamassassin_pipe for $local_part@$domain"
                driver = pipe
                command = /usr/sbin/exim4 -oMr spam-scanned -bS
                use_bsmtp
                # run the filter as debian-spamd because it has access to all of the
                # spamassassin files
                transport_filter = /usr/bin/spamc -u debian-spamd
                home_directory = "/tmp"
                current_directory = "/tmp"
                # must use a privileged user to set $received_protocol on the way back in!
                user = Debian-exim
                group = Debian-spamd
                return_fail_output
                message_prefix =
                message_suffix =

              # This delivers mail via dovecot to the Junk folder. 
              dovecot_spam_junk_delivery:
                driver = pipe
                # You may or may not want to add -d $local_part@$domain depending on if 
                # you need a userdb lookup done.
                command = /usr/lib/dovecot/dovecot-lda -f $sender_address -m Junk
                message_prefix =
                message_suffix =
                log_output
                delivery_date_add
                envelope_to_add
                return_path_add
                #group = mail
                #mode = 0660
                temp_errors = 64 : 69 : 70: 71 : 72 : 73 : 74 : 75 : 78

   1. Edit `/etc/spamassassin/local.cf` and change as follows:

          rewrite_header Subject *****SPAM*****

      Then add the following to `/etc/spamassassin/local.cf`, so that it uses the above (note that the last part of `bayes_path` is a prefix, not a directory).

          use_bayes 1
          bayes_path /var/spamassassin/bayes_db/bayes
          bayes_file_mode 0660

   1. Once all of the above is set up, do:

          echo CRON=1 | sudo tee /etc/default/spamassassin

   1. And edit `/etc/default/spamd`

       and change the line :

          OPTIONS="--create-prefs --max-children 5 --helper-home-dir"

       to be like this:

          OPTIONS="--create-prefs --max-children 2 --helper-home-dir --username=debian-spamd"

       because, for some reason, the username isn't set by default, and we only have a couple of users so don't need to run a ton of daemons.

   1. And then enable it:

          sudo update-rc.d spamd enable
          sudo service spamd restart

   1. Set up the global bayes learning directory. It will be group rw for the `adm` group, as it's assumed that only those users would ssh in and teach it things. Also, `spamd` changes uid to `Debian-exim`, so make sure that user owns the DB and can read things. (You may have to run the `chown` again after creating the databases with `sa-learn`). It also likes to change group IDs on the files, so you need to make sure that all those are correct, and that any users who are going to train SA are in the `Debian-exim` group (which implies that you trust them).

           sudo mkdir -p /var/spamassassin/bayes_db
           sudo chown -R Debian-exim:debian-spamd /var/spamassassin
           sudo chmod -R g+rwX /var/spamassassin
           sudo chmod g+s /var/spamassassin
           sudo usermod -a -G debian-spamd <user list>

       The g+s looks a little odd here, but let me explain. The `spamcheck` transport runs as `Debian-exim`, which will create `/var/spamassassin/bayes_journal` if it does not exist. However, the `spamd` process likes to run as `debian-spamd` (so it can access all its files), which won't be able to read said journal and will complain  bitterly. By setting the directory to be setgid, all created files will have the correct gid set, ensuring that both `Debian-exim` and `debian-spamd` can read and write everything in it. This also means that the `sa_learn` wrapper that I run periodically will work, because I am in the `debian-spamd` group.

   1. And, because linode's customers regularly exceed the allowable DNS queries from the free services (see [this post](https://www.linode.com/community/questions/21413/rcvd_in_dnswl_hi-false-positives)), add the following lines to the bottom of `/etc/spamassassin/local.cf`, so they won't be used in the scoring.

          dns_query_restriction deny multi.uribl.com
          dns_query_restriction deny bl.score.senderscore.com
          dns_query_restriction deny sa-trusted.bondedsender.org
          dns_query_restriction deny sa-accredit.habeas.com

   1. restart

          sudo service spamd restart

1. Edit `/etc/aliases` and:

   1. change root to go to matt:

          root: matt
