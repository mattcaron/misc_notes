# Instructions for installing Ubuntu 22.04 on cameras (the Zoneminder NVR system)

## Base install and configs:

1. Install Ubuntu server as normal from an Ubuntu server install CD. I selected
   the minimal option for a headless server.

    Partition as follows, for both disks - which we're going to RAID.

    * /`boot` - 1GB (physical RAID)

    * rest (physical RAID)
        * Make this RAID LVM, partitioned as follows:

              /     - 100GB
              /tmp  - 50GB
              /var  - 100GB
              swap  - 10GB
              /home - rest

    When it asks for what to install, install "OpenSSH server" and leave
    everything else blank.

    Networking is already set up with a reserved DHCP lease on the router. It is
    accessible as `cameras`. No need for a static IP.

1. After machine is up, edit `/etc/apt/sources.list` and make sure the following are enabled:

    * jammy restricted main
    * jammy-updates restricted main
    * jammy universe
    * jammy-updates universe
    * jammy multiverse
    * jammy-updates multiverse
    * jammy-backports multiverse universe restricted main
    * jammy-security restricted main
    * jammy-security multiverse
    * jammy-security universe

    (they were after install for me)

1. Make sure all is up to date.

        sudo apt update
        sudo apt dist-upgrade

1. Install more useful things

       sudo apt install net-tools tree atop nmap iotop emacs emacs-goodies-el elpa-go-mode elpa-rust-mode elpa-f elpa-let-alist elpa-markdown-mode elpa-yaml-mode elpa-flycheck lm-sensors ntp ssmtp gdisk git gitk iftop mailutils ppa-purge xsltproc smartmontools

1. Add any necessary user accounts

1. Make ssh work:

    1. For an old machine, use the old keys - you did save /etc, didn't you?

    1. For a new machine, use the new keys generated by the distro.

        * make sure to add to the firewall

              sudo ufw allow ssh

        * edit `/etc/ssh/sshd_config` and set:

              PermitRootLogin no

        * once you've set up public key auth, turn off password access - edit `
          /etc/ssh/sshd_config` and set

              PasswordAuthentication no

        * restart ssh to apply changes

              sudo service ssh restart

1. Enable firewall, bit first, disable firewally logging (it can be quite
   verbose on a busy network), then turn on the firewall.

        sudo ufw logging off
        sudo ufw enable

1. Set up sensors for ASUS i7 board (I forget the model)

    add the following to /etc/modules:

         coretemp
         i5500_temp
         w83627ehf

1. Set up ssmtp

        cd /etc/ssmtp
        mv ssmtp.conf ssmtp.conf.old
        cp ~/system_stuff/ssmtp/ssmtp.conf .
        chgrp mail ssmtp.conf

1. Add monitoring (sortof):

    make sure landscape is installed (to get landscape-sysinfo):

       sudo apt install landscape-common

    Then add the following to my crontab:

       @daily               /usr/bin/ntpq -p; echo; df -lh; echo; cat /proc/mdstat; landscape-sysinfo

## Zoneminder basic set up:

1. Refs: 
    * https://zoneminder.readthedocs.io/en/latest/installationguide/ubuntu.html

1. Install deps:

       sudo apt-get install tasksel
       sudo tasksel install web-server

1. Add the PPA and do the basic install:

       sudo add-apt-repository ppa:iconnor/zoneminder-1.36
       sudo apt install zoneminder

1. Fix some perms and ownership:

       sudo chmod 740 /etc/zm/zm.conf
       sudo chown root:www-data /etc/zm/zm.conf
       sudo chown -R www-data:www-data /usr/share/zoneminder/

1. Enable apache modules Zoneminder config:

       sudo a2enmod cgi
       sudo a2enmod rewrite
       sudo a2enmod expires
       sudo a2enmod headers
       sudo a2enconf zoneminder

1. Let it through the firewall

       sudo ufw allow http

1. Enable and start zoneminder:

       sudo systemctl enable zoneminder
       sudo systemctl start zoneminder

1. Reload apache:

       sudo systemctl reload apache2

1. Going to http://cameras/zm should now work.

## Add neolink

(So Reolink wireless cameras work)

**Note**: I did this on my desktop, not the server. Since both run the same OS
and it's a (mostly) statically compiled rust binary, I just plan to copy it
over from dev box to server.

1. Clone it from its repo:

       git clone https://github.com/thirtythreeforty/neolink.git

1. Make sure rust and cargo are updated:

       rustup update

1. Make sure dependencies are installed (this is non-exhaustive, these are just
   the ones I had to add)

       sudo apt install libgstreamer1.0-dev libgstreamer-plugins-bad1.0-dev libgstreamer-plugins-good1.0-dev libgstrtspserver-1.0-dev

1. Then one can build it successfully with:

       cargo build